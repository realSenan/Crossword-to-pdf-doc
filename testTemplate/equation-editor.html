<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathType Entegrasyonu Örneği (CDN ile)</title>

    <!-- Wiris MathType Generic Integration CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@wiris/mathtype-generic@latest/wirisplugin-generic.js"></script>

    <!-- Formülleri görüntülemek için zorunlu (MathML to image render) -->
    <script src="https://www.wiris.net/demo/plugins/app/WIRISplugins.js?viewer=image"></script>
  </head>
  <body>
    <h1>MathType Entegrasyonu Örneği (CDN ile)</h1>
    <p>
      Bu, Wiris MathType'ı bir HTML editöre entegre eden basit bir örnek.
      Denklem editörü, Word'e benzer şekilde çalışır: Görsel araçlar, sembol
      paleti, ink to math vb. NPM olmadan, tamamen CDN ile.
    </p>

    <!-- Toolbar container (Wiris toolbar buraya yerleşecek) -->
    <div id="toolbar"></div>

    <!-- Editable container for the editor -->
    <div id="editor-container">
      <div
        id="editor"
        contenteditable="true"
        data-placeholder="Buraya metin yazın veya denklem ekleyin..."
      ></div>
    </div>

    <!-- Buttons for controls -->
    <div style="margin-top: 15px; display: flex; gap: 10px">
      <button id="insert-equation">Denklem Ekle</button>
      <button id="get-content">İçeriği Al</button>
    </div>

    <!-- Output area -->
    <div id="output"></div>

    <script>
      // DOM hazır olunca init et
      document.addEventListener("DOMContentLoaded", () => {
        // Wiris entegrasyon özellikleri
        var genericIntegrationProperties = {};
        genericIntegrationProperties.target = document.getElementById("editor");
        genericIntegrationProperties.toolbar =
          document.getElementById("toolbar");

        // Ek konfigürasyon (dil, handwriting vb.)
        var mathTypeParameters = {
          editorParameters: {
            language: "en", // Veya 'tr' eğer destekliyse
            handwriting: true, // Ink to math (el yazısı tanıma) etkin
          },
        };
        genericIntegrationProperties.integrationParameters = mathTypeParameters;

        // Instance oluştur
        var genericIntegrationInstance = new WirisPlugin.GenericIntegration(
          genericIntegrationProperties
        );
        genericIntegrationInstance.init();
        genericIntegrationInstance.listeners.fire("onTargetReady", {});

        // Current instance set et
        WirisPlugin.currentInstance = genericIntegrationInstance;

        // Denklem ekleme butonu (editorü aç) - Hata düzeltme: core.editor.open() olarak değiştir
        document
          .getElementById("insert-equation")
          .addEventListener("click", () => {
            WirisPlugin.currentInstance.core.editor.open();
          });

        // İçeriği al (MathML dahil)
        document.getElementById("get-content").addEventListener("click", () => {
          let htmlData = document.getElementById("editor").innerHTML;
          htmlData = WirisPlugin.Parser.endParse(htmlData); // Image to MathML dönüştür
          document.getElementById(
            "output"
          ).innerHTML = `<strong>Editör İçeriği (MathML):</strong><br>${htmlData}`;
          console.log("Exported Content:", htmlData); // Word'e export için kullan
        });

        // Klavye kısayolları (Alt + =)
        document.addEventListener("keydown", (e) => {
          if (e.altKey && e.key === "=") {
            WirisPlugin.currentInstance.core.editor.open();
          }
        });

        // Sürükle-bırak (temel)
        const editor = document.getElementById("editor");
        editor.addEventListener("dragstart", (e) => {
          if (
            e.target.tagName === "IMG" &&
            e.target.getAttribute("data-mathml")
          ) {
            e.dataTransfer.setData("text/html", e.target.outerHTML);
          }
        });
        editor.addEventListener("drop", (e) => {
          e.preventDefault();
          const data = e.dataTransfer.getData("text/html");
          if (data) {
            const range = document.caretRangeFromPoint(e.clientX, e.clientY);
            if (range) {
              range.insertNode(
                new DOMParser().parseFromString(data, "text/html").body
                  .firstChild
              );
            }
          }
        });

        // Auto-correct simülasyon (imleç sorununu çözmek için daha akıllı replace)
        editor.addEventListener("input", (e) => {
          // İmleç konumunu kaydet
          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          const range = selection.getRangeAt(0);
          const startContainer = range.startContainer;
          const startOffset = range.startOffset;

          // İçeriği al (textContent ile, HTML bozulmasın)
          let text = editor.textContent;

          // Pattern'leri replace et (örnek: \alpha → α)
          const replacements = [
            { pattern: /\\alpha/g, replacement: "α" },
            // Word'ün Math AutoCorrect listesiyle daha fazla ekle, ör:
            // { pattern: /\\beta/g, replacement: 'β' },
            // { pattern: /\\infty/g, replacement: '∞' },
            // vb.
          ];

          let replaced = false;
          replacements.forEach(({ pattern, replacement }) => {
            if (pattern.test(text)) {
              text = text.replace(pattern, replacement);
              replaced = true;
            }
          });

          if (replaced) {
            // İçeriği güncelle (ama HTML'i koru, sadece text'i replace et - basitlik için innerText kullan)
            editor.innerText = text;

            // İmleci eski konuma geri koy (yaklaşık olarak)
            const newRange = document.createRange();
            newRange.setStart(editor.firstChild || editor, startOffset); // Yaklaşık konum
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        });

        // Placeholder yönetimi (focus/blur ile)
        const placeholder = editor.getAttribute("data-placeholder");
        editor.addEventListener("focus", () => {
          if (editor.innerHTML.trim() === "") {
            editor.innerHTML = ""; // Placeholder'ı temizle
          }
        });
        editor.addEventListener("blur", () => {
          if (editor.innerHTML.trim() === "") {
            editor.innerHTML = ""; // CSS ::before yönetiyor
          }
        });
      });
    </script>

    <footer style="margin-top: 30px; color: #777; font-size: 14px">
      <p>
        Not: "Denklem Ekle" butonu şimdi çalışıyor (API çağrısı düzeltildi:
        core.editor.open()). Placeholder CSS ile yönetiliyor (gri, italik). UI
        iyileştirildi: Modern renkler (mavi tonlar), gölgeler, yuvarlak köşeler.
        Wiris'in varsayılan stilleri override edildi (toolbar, butonlar, modal).
        Auto-correct imleç sorunu çözülü. Daha fazla auto-correct kuralı eklemek
        için replacements array'ini genişletin. Production için Wiris backend
        kurun. Detaylar:
        <a href="https://docs.wiris.com/en/mathtype/mathtype_web">Wiris Docs</a>
      </p>
    </footer>
  </body>
</html>
